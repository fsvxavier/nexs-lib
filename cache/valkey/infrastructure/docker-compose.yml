version: '3.8'

services:
  # ===================================
  # STANDALONE CONFIGURATION
  # ===================================
  valkey-standalone:
    image: valkey/valkey:7-alpine
    container_name: valkey-standalone
    ports:
      - "6379:6379"
    command: >
      valkey-server
      --requirepass testpass123
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - valkey_standalone_data:/data
      - ./config/standalone.conf:/etc/valkey/valkey.conf:ro
    networks:
      - valkey-network
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "testpass123", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ===================================
  # CLUSTER CONFIGURATION (6 nodes)
  # ===================================
  valkey-cluster-node-1:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-1
    ports:
      - "7000:7000"
      - "17000:17000"
    command: >
      valkey-server
      --port 7000
      --cluster-enabled yes
      --cluster-config-file nodes-7000.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_1_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-cluster-node-2:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-2
    ports:
      - "7001:7001"
      - "17001:17001"
    command: >
      valkey-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes-7001.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_2_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-cluster-node-3:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-3
    ports:
      - "7002:7002"
      - "17002:17002"
    command: >
      valkey-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes-7002.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_3_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-cluster-node-4:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-4
    ports:
      - "7003:7003"
      - "17003:17003"
    command: >
      valkey-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes-7003.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_4_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-cluster-node-5:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-5
    ports:
      - "7004:7004"
      - "17004:17004"
    command: >
      valkey-server
      --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes-7004.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_5_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-cluster-node-6:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-node-6
    ports:
      - "7005:7005"
      - "17005:17005"
    command: >
      valkey-server
      --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes-7005.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --appendfsync everysec
      --requirepass clusterpass123
      --masterauth clusterpass123
    volumes:
      - valkey_cluster_6_data:/data
    networks:
      - valkey-network
    restart: unless-stopped

  # Cluster setup service - runs once to create the cluster
  valkey-cluster-setup:
    image: valkey/valkey:7-alpine
    container_name: valkey-cluster-setup
    depends_on:
      - valkey-cluster-node-1
      - valkey-cluster-node-2
      - valkey-cluster-node-3
      - valkey-cluster-node-4
      - valkey-cluster-node-5
      - valkey-cluster-node-6
    command: >
      sh -c "
        sleep 10 &&
        echo 'Creating Valkey cluster...' &&
        valkey-cli --cluster create
        valkey-cluster-node-1:7000
        valkey-cluster-node-2:7001
        valkey-cluster-node-3:7002
        valkey-cluster-node-4:7003
        valkey-cluster-node-5:7004
        valkey-cluster-node-6:7005
        --cluster-replicas 1
        --cluster-yes
        -a clusterpass123 &&
        echo 'Cluster created successfully!'
      "
    networks:
      - valkey-network
    restart: "no"

  # ===================================
  # SENTINEL CONFIGURATION
  # ===================================
  valkey-sentinel-master:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-master
    ports:
      - "6380:6379"
    command: >
      valkey-server
      --requirepass sentinelpass123
      --masterauth sentinelpass123
      --appendonly yes
      --appendfsync everysec
    volumes:
      - valkey_sentinel_master_data:/data
      - ./config/sentinel-master.conf:/etc/valkey/valkey.conf:ro
    networks:
      - valkey-network
    restart: unless-stopped

  valkey-sentinel-slave-1:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-slave-1
    ports:
      - "6381:6379"
    command: >
      valkey-server
      --requirepass sentinelpass123
      --masterauth sentinelpass123
      --replicaof valkey-sentinel-master 6379
      --appendonly yes
      --appendfsync everysec
    volumes:
      - valkey_sentinel_slave1_data:/data
    networks:
      - valkey-network
    depends_on:
      - valkey-sentinel-master
    restart: unless-stopped

  valkey-sentinel-slave-2:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-slave-2
    ports:
      - "6382:6379"
    command: >
      valkey-server
      --requirepass sentinelpass123
      --masterauth sentinelpass123
      --replicaof valkey-sentinel-master 6379
      --appendonly yes
      --appendfsync everysec
    volumes:
      - valkey_sentinel_slave2_data:/data
    networks:
      - valkey-network
    depends_on:
      - valkey-sentinel-master
    restart: unless-stopped

  valkey-sentinel-1:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-1
    ports:
      - "26379:26379"
    command: valkey-sentinel /etc/valkey/sentinel.conf
    volumes:
      - ./config/sentinel.conf:/etc/valkey/sentinel.conf:ro
    networks:
      - valkey-network
    depends_on:
      - valkey-sentinel-master
      - valkey-sentinel-slave-1
      - valkey-sentinel-slave-2
    restart: unless-stopped

  valkey-sentinel-2:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-2
    ports:
      - "26380:26379"
    command: valkey-sentinel /etc/valkey/sentinel.conf
    volumes:
      - ./config/sentinel.conf:/etc/valkey/sentinel.conf:ro
    networks:
      - valkey-network
    depends_on:
      - valkey-sentinel-master
      - valkey-sentinel-slave-1
      - valkey-sentinel-slave-2
    restart: unless-stopped

  valkey-sentinel-3:
    image: valkey/valkey:7-alpine
    container_name: valkey-sentinel-3
    ports:
      - "26381:26379"
    command: valkey-sentinel /etc/valkey/sentinel.conf
    volumes:
      - ./config/sentinel.conf:/etc/valkey/sentinel.conf:ro
    networks:
      - valkey-network
    depends_on:
      - valkey-sentinel-master
      - valkey-sentinel-slave-1
      - valkey-sentinel-slave-2
    restart: unless-stopped

volumes:
  valkey_standalone_data:
    driver: local
  valkey_cluster_1_data:
    driver: local
  valkey_cluster_2_data:
    driver: local
  valkey_cluster_3_data:
    driver: local
  valkey_cluster_4_data:
    driver: local
  valkey_cluster_5_data:
    driver: local
  valkey_cluster_6_data:
    driver: local
  valkey_sentinel_master_data:
    driver: local
  valkey_sentinel_slave1_data:
    driver: local
  valkey_sentinel_slave2_data:
    driver: local

networks:
  valkey-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
